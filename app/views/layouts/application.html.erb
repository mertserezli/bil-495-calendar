<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
* {box-sizing: border-box;}
ul {list-style-type: none;}
body {font-family: Verdana, sans-serif;}
.month {
    padding: 70px 25px;
    width: 100%;
    background: #1abc9c;
    text-align: center;
}
.month ul {
    margin: 0;
    padding: 0;
}
.month ul li {
    color: white;
    font-size: 20px;
    text-transform: uppercase;
    letter-spacing: 3px;
}
.month .prev {
    float: left;
    padding-top: 10px;
}
.month .next {
    float: right;
    padding-top: 10px;
}
.weekdays {
    margin: 0;
    padding: 10px 0;
    background-color: #ddd;
}
.weekdays li {
    display: inline-block;
    width: 13.6%;
    color: #666;
    text-align: center;
}
.days {
    padding: 10px 0;
    background: #eee;
    margin: 0;
}
.days li {
    display: inline-block;
    width: 22%;
    text-align: center;
    margin-bottom: 5px;
    margin-top:5px;
    font-size:12px;
    color: #777;
}
.days li .active {
    padding: 5px;
    background: #1abc9c;
    color: white !important
}
/* Add media queries for smaller screens */
@media screen and (max-width:720px) {
    .weekdays li, .days li {width: 13.1%;}
}
@media screen and (max-width: 420px) {
    .weekdays li, .days li {width: 12.5%;}
    .days li .active {padding: 2px;}
}
@media screen and (max-width: 290px) {
    .weekdays li, .days li {width: 12.2%;}
}
</style>
    
    <title>Bil495Calendar</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
  </head>

  <body>
  
    <%= yield %>
	
    <div class="month">      
    <ul>
      <li class="prev" onClick=(changeMonth(0))>&#10094;</li>
      <li class="next" onClick=(changeMonth(1))>&#10095;</li>
      <li id="month">
      <script>
      
        	var months=["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
        	var currentDate = new Date(); 
			currentMonth= currentDate.getMonth();
			currentYear= currentDate.getFullYear();
      		function changeMonth(index){
      			if(index==0){
      				document.getElementById("month").innerHTML = getPreviousMonth() + " " + currentYear;
					document.getElementById("days").innerHTML=Days();
      			}
      			else{
      				document.getElementById("month").innerHTML = getNextMonth() + " " + currentYear;
					document.getElementById("days").innerHTML=Days();
      			}
      		}
    		function getCurrentMonth(){
	 			 return months[currentMonth];
    		}
    		function getPreviousMonth(){
    			if(currentMonth!=0)
    				currentMonth-=1;
				else{
					currentMonth=11;
					currentYear-=1;
				}
    			return months[currentMonth];
    		}
    		function getNextMonth(){
    			if(currentMonth!=11)
    				currentMonth+=1;
				else{
					currentMonth=0;
					currentYear+=1;
				}
    			return months[currentMonth];
    		}
			
      		document.getElementById("month").innerHTML = getCurrentMonth() + " " + currentYear; 
      
      </script>
      </li>
    </ul>
    </div> 

  <ul class="days" id="days"> 
  
  <script>
  function GetJSON(yourUrl){
    var Httpreq = new XMLHttpRequest(); // a new request
    Httpreq.open("GET",yourUrl,false);
    Httpreq.send(null);
    return Httpreq.responseText;          
  }

  jsonObject=JSON.parse(GetJSON('http://' + window.location.host + '/appointments.json'));

  function Days(){
    var d='';
    
    for(i=1;i<32;i++){
      d=d+'<li id='+i+' onclick=\"showApps(currentYear, currentMonth+1, id)\">'+i;
      var y;
      for(y=0;y<jsonObject.length;y++){
        if( 
		( jsonObject[y].date.substring(8,10)==i || ((i > Number(jsonObject[y].date.substring(8,10))) 
		&& (i - Number(jsonObject[y].date.substring(8,10))) % jsonObject[y].recurseDays == 0) )
		&& Number(jsonObject[y].date.substring(5,7))==currentMonth + 1 && jsonObject[y].date.substring(0,4)==currentYear){
          d= d+"#";
        }
        
      }
      d=d+'</li>';   
    } 
    return d;
  }

  document.getElementById("days").innerHTML=Days();

  function showApps(year,month,day){
      var result='';
      for(var y=0;y<jsonObject.length;y++){
        if(jsonObject[y].recursive){
            if(Number(jsonObject[y].date.substring(8,10))<=day && Number(jsonObject[y].date.substring(5,7))==month && Number(jsonObject[y].date.substring(0,4))==year
                && (day - jsonObject[y].date.substring(8,10)) % jsonObject[y].recurseDays==0){
              result+=jsonObject[y].date.substring(11,16)+"--"+jsonObject[y].description+'\n';
            }
        }
        else{
            if(Number(jsonObject[y].date.substring(8,10))==day && Number(jsonObject[y].date.substring(5,7))==month && Number(jsonObject[y].date.substring(0,4))==year){
                result+=jsonObject[y].date.substring(11,16)+"--"+jsonObject[y].description+'\n';    
            }
        } 
      }
      alert(result);
      console.log(year+" "+month+" "+day);
  }

  function search(keyword){
  	  var xhttp = new XMLHttpRequest();
      xhttp.open("POST", 'http://' + window.location.host + '//appointmentsSearch.json', true);
      xhttp.setRequestHeader("Content-type", "application/json");
      var data = JSON.stringify({"description":keyword, "date":"2018-06-26T00:00:00.000Z", "recursive":false, "recurseDays":null});
          xhttp.onreadystatechange = function () {
          if (xhttp.readyState === 4 && xhttp.status === 200) {
              var appointments = JSON.parse(xhttp.responseText);
              var found = ""
              for (i in appointments) {
                  found += appointments[i].description + ": " + appointments[i].date.substr(0, appointments[i].date.length - 5) + "\n";
              }
              alert(found);
          }
      };
      xhttp.send(data)
  }

  </script>

  </ul>

  <form onsubmit = "search(keyword.value);return false">
      Search:<br>
      <input type = "text" name = "keyword" value = "Enter a keyword to search">
      <input type = "submit" value = "Submit">
  </form> 

  </body>
 
  
</html>